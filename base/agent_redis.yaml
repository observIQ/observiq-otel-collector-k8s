apiVersion: opentelemetry.io/v1alpha1
kind: OpenTelemetryCollector
metadata:
  name: observiq-redis
  namespace: default
spec:
  mode: sidecar
  config: |
    receivers:
      redis:
        endpoint: 127.0.0.1:6379
        collection_interval: 60s

    processors:
      # resource attributes will be used to map the metrics
      # to Google Monitored Resource type 'k8s_node'
      # https://cloud.google.com/logging/docs/api/v2/resource-list#resource-types
      resource:
        attributes:
        - key: opencensus.resourcetype
          value: pod
          action: upsert  
        - key: k8s.cluster.name
          value: poc
          action: upsert
        - key: k8s.cluster.location
          value: us-east1
          action: upsert
        - key: k8s.namespace.name
          value: "${K8S_NAMESPACE}"
          action: upsert
        - key: k8s.pod.name
          value: "${K8S_POD_NAME}"
          action: upsert
        - key: k8s.node.name
          value: "${K8S_NODE_NAME}"
          action: upsert

      resourceattributetransposer:
        operations:
          # Node name is useful when troubleshooting pods / containers. We must copy it here
          # because Google will strip it away as it is not part of the monitored resource type.
          - from: k8s.node.name
            to: node_name

    exporters:
      otlp:
        endpoint: observiq-gcp-gateway:4317
        tls:
          insecure: true

    service:
      pipelines:
        metrics:
          receivers:
            - redis
          processors:
            - resource
            - resourceattributetransposer
          exporters:
            - otlp

  image: observiq/observiq-otel-collector:v0.4.1
  resources:
    limits:
      memory: "250Mi"
      cpu: 200m
    requests:
      memory: "125Mi"
      cpu: 100m
  env:
    - name: K8S_NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    - name: K8S_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: K8S_POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
